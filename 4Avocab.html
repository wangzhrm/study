<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››å¹´çº§è¯­æ–‡è¯è¯­é—¯å…³ (çœŸé¢˜çº§äº‘ç«¯ç‰ˆ)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3ecf8e; --success: #27ae60; --error: #e74c3c; --bg: #f8f9fa; }
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; width: 95%; max-width: 800px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); min-height: 550px; position: relative; }
        h1 { font-size: 22px; color: var(--primary); text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f1f1f1; padding-bottom: 15px; }
        .btn { padding: 18px; border: none; border-radius: 12px; cursor: pointer; font-size: 17px; font-weight: bold; width: 100%; margin-bottom: 12px; transition: 0.2s; }
        .btn-main { background: var(--accent); color: white; }
        .btn-main:active { transform: scale(0.98); }
        .opt-btn { background: #fff; border: 2px solid #eaeeef; text-align: left; font-weight: normal; padding: 18px; color: #34495e; font-size: 17px; line-height: 1.6; }
        .opt-btn:hover { border-color: var(--accent); background: #f0f7ff; }
        .hidden { display: none; }
        .pinyin-box { font-size: 55px; text-align: center; margin: 60px 0; color: #e67e22; letter-spacing: 5px; font-weight: bold; }
        .progress-bar { text-align: right; font-size: 13px; color: #95a5a6; margin-bottom: 10px; }
        #loading { text-align: center; padding: 100px 20px; color: #95a5a6; font-size: 18px; }
        .result-card { background: #fdfefe; border-radius: 12px; padding: 15px; margin-top: 15px; border: 1px solid #eee; max-height: 400px; overflow-y: auto; }
        .review-item { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .wrong-text { color: var(--error); font-size: 15px; text-decoration: line-through; }
        .right-text { color: var(--success); font-size: 15px; font-weight: bold; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="title">å››å¹´çº§è¯è¯­é—¯å…³ (çœŸé¢˜çº§)</h1>
    <div id="loading">æ­£åœ¨ä»äº‘ç«¯è·å–çœŸé¢˜åº“...</div>

    <div id="main-menu" class="hidden">
        <p style="text-align:center; color:#7f8c8d; margin-bottom:20px;">è¯·é€‰æ‹©é—¯å…³æ¨¡å¼</p>
        <button class="btn btn-main" onclick="start(1)">1. æ ‡æ³¨æ‹¼éŸ³ç»ƒä¹  (çº¸ç¬”é»˜å†™)</button>
        <button class="btn btn-main" onclick="start(2)">2. æ˜“é”™è¯»éŸ³è¾¨æ (æ¯é¢˜3ç»„è¯)</button>
        <button class="btn btn-main" onclick="start(3)">3. æ˜“é”™å½¢è¿‘å­—è¾¨æ (æ¯é¢˜3ç»„è¯)</button>
    </div>

    <div id="quiz-page" class="hidden">
        <div class="progress-bar" id="prog-txt"></div>
        <div id="quiz-content"></div>
        <div id="nav-area" class="hidden" style="margin-top:20px;">
            <button class="btn btn-main" style="width:auto; float:right; padding:10px 40px;" onclick="goNext()">ä¸‹ä¸€ä¸ª</button>
        </div>
    </div>

    <div id="result-page" class="hidden">
        <h2 style="text-align:center; color:var(--success)">æŒ‘æˆ˜ç»“æŸï¼</h2>
        <div id="score-box" style="text-align:center; font-size:24px; font-weight:bold; margin:20px 0;"></div>
        <div id="result-detail" class="result-card"></div>
        <button class="btn btn-main" style="margin-top:25px; background:#2ecc71" onclick="location.reload()">å›ä¸»èœå•</button>
    </div>
</div>

<script>
const PROJECT_ID = "wqvegiyfqpbqgzpmrrds";
const ANON_KEY = "sb_publishable_iLS1hJ8VgcxVFraIxtFPTA_71Ssmn3m";
const API_URL = `https://${PROJECT_ID}.supabase.co/rest/v1/words_library?select=w,p,trap_w,trap_p`;

let fullData = [], list = [], mode = 0, idx = 0, score = 0, history = [];

async function init() {
    try {
        const response = await fetch(API_URL, { headers: { 'apikey': ANON_KEY, 'Authorization': `Bearer ${ANON_KEY}` } });
        fullData = await response.json();
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
    } catch (err) {
        document.getElementById('loading').innerHTML = `âŒ è¿æ¥æ•°æ®åº“å¤±è´¥`;
    }
}

function start(m) {
    mode = m; idx = 0; score = 0; history = [];
    list = [...fullData].sort(() => Math.random() - 0.5);
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('quiz-page').classList.remove('hidden');
    render();
}

function render() {
    const content = document.getElementById('quiz-content');
    const prog = document.getElementById('prog-txt');
    const nav = document.getElementById('nav-area');

    if (idx >= list.length) { showFinal(); return; }

    if (mode === 1) {
        prog.innerText = `å½“å‰è¿›åº¦ï¼š${idx + 1} / ${list.length}`;
        nav.classList.remove('hidden');
        content.innerHTML = `<div class="pinyin-box">${list[idx].p}</div><p style="text-align:center; color:#95a5a6">è¯·åœ¨çº¸ä¸Šé»˜å†™å‡ºå¯¹åº”çš„è¯è¯­</p>`;
    } else {
        prog.innerText = `é¢˜ç›®ï¼š${Math.floor(idx/9) + 1} / ${Math.ceil(list.length/9)}`;
        nav.classList.add('hidden');
        generateAdvancedChallenge();
    }
}

function generateAdvancedChallenge() {
    const content = document.getElementById('quiz-content');
    let slice = list.slice(idx, idx + 9);
    while(slice.length < 9) slice.push(fullData[Math.floor(Math.random()*fullData.length)]);

    let correctIdx = Math.floor(Math.random() * 3);
    let options = [];

    for (let i = 0; i < 3; i++) {
        let isGroupCorrect = (i === correctIdx);
        let groupItems = [slice[i*3], slice[i*3+1], slice[i*3+2]];
        
        // Pick one item in the incorrect group to be the "Trap"
        let trapTargetIdx = Math.floor(Math.random() * 3);

        let optionTexts = groupItems.map((item, itemIdx) => {
            // If group is wrong AND this is the designated trap item
            if (!isGroupCorrect && itemIdx === trapTargetIdx) {
                if (mode === 2) {
                    let badP = item.trap_p || item.p.replace('sh','s').replace('zh','z');
                    return `${item.w}(${badP})`;
                } else {
                    let badW = item.trap_w || item.w.replace(item.w[0], "æ‹Ÿ");
                    return badW;
                }
            }
            // Otherwise show correct version
            return mode === 2 ? `${item.w}(${item.p})` : item.w;
        });

        // Store the correct version for this specific group to show in review if needed
        let correctVersion = groupItems.map(item => mode === 2 ? `${item.w}(${item.p})` : item.w).join("ã€");
        
        options.push({ 
            displayText: optionTexts.join("ã€"), 
            isCorrect: isGroupCorrect,
            correctAnswer: "" // Handled in checkAnswer
        });
    }
    
    // Find the correct group's text to store in the wrong answer history
    const actualCorrectText = options.find(o => o.isCorrect).displayText;

    content.innerHTML = `<h3 style="margin-bottom:20px; font-size:18px;">æ‰¾å‡ºä¸€ç»„ <span style="color:var(--accent)">å®Œå…¨æ­£ç¡®</span> çš„è¯è¯­ï¼š</h3>` + 
        `<div style="display:grid; gap:15px;">` +
        options.map(o => `<button class="btn opt-btn" onclick="checkAnswer(${o.isCorrect}, '${o.displayText}', '${actualCorrectText}')">${o.displayText}</button>`).join('') +
        `</div>`;
}

function checkAnswer(isCorrect, selectedText, correctText) {
    if (isCorrect) {
        score++;
    } else {
        history.push({ selected: selectedText, correct: correctText });
    }
    idx += 9;
    render();
}

function goNext() {
    idx++;
    render();
}

function showFinal() {
    document.getElementById('quiz-page').classList.add('hidden');
    const resPage = document.getElementById('result-page');
    resPage.classList.remove('hidden');

    const totalQuestions = mode === 1 ? list.length : Math.ceil(list.length/9);
    const percent = Math.round(score/totalQuestions*100);
    document.getElementById('score-box').innerText = mode === 1 ? "ç»ƒä¹ å®Œæˆï¼" : `å¾—åˆ†ï¼š${percent}% (${score}/${totalQuestions})`;
    
    const detail = document.getElementById('result-detail');
    if (mode === 1) {
        detail.innerHTML = `<p>æ ¸å¯¹é»˜å†™ï¼š</p><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">` + 
            list.map(i => `<div style="font-size:13px; border-bottom:1px solid #eee;">${i.p}<br><b>${i.w}</b></div>`).join('') + `</div>`;
    } else {
        if (history.length > 0) {
            detail.innerHTML = `<p style="color:var(--error); font-weight:bold; margin-bottom:15px;">é”™é¢˜å›é¡¾ï¼š</p>` + 
                history.map(h => `
                    <div class="review-item">
                        <div style="font-size:12px; color:#999;">ä½ çš„é€‰æ‹©ï¼š</div>
                        <div class="wrong-text">${h.selected}</div>
                        <div style="font-size:12px; color:#999; margin-top:8px;">æ­£ç¡®ç­”æ¡ˆåº”è¯¥æ˜¯ï¼š</div>
                        <div class="right-text">${h.correct}</div>
                    </div>
                `).join('');
        } else {
            detail.innerHTML = `<p style="color:var(--success); text-align:center; font-size:18px; margin-top:20px;">ğŸ‰ çœŸå‰å®³ï¼é¿å¼€äº†æ‰€æœ‰åœ°é›·ï¼</p>`;
        }
    }
}

init();
</script>
</body>
</html>
