<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å››å¹´çº§è¯­æ–‡è¯è¯­é—¯å…³ (çœŸé¢˜ç²¾å‡†ç‰ˆ)</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3ecf8e; --success: #27ae60; --error: #e74c3c; --bg: #f8f9fa; }
        body { font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; background: var(--bg); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { background: white; width: 95%; max-width: 800px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); min-height: 550px; }
        h1 { font-size: 22px; color: var(--primary); text-align: center; margin-bottom: 20px; border-bottom: 2px solid #f1f1f1; padding-bottom: 15px; }
        .btn { padding: 18px; border: none; border-radius: 12px; cursor: pointer; font-size: 17px; font-weight: bold; width: 100%; margin-bottom: 12px; transition: 0.2s; }
        .btn-main { background: var(--accent); color: white; }
        .opt-btn { background: #fff; border: 2px solid #eaeeef; text-align: left; font-weight: normal; padding: 18px; color: #34495e; font-size: 17px; line-height: 1.6; }
        .opt-btn:hover { border-color: var(--accent); background: #f0f7ff; }
        .hidden { display: none; }
        .pinyin-box { font-size: 55px; text-align: center; margin: 60px 0; color: #e67e22; font-weight: bold; }
        .progress-bar { text-align: right; font-size: 13px; color: #95a5a6; margin-bottom: 10px; }
        .result-card { background: #fdfefe; border-radius: 12px; padding: 15px; margin-top: 15px; border: 1px solid #eee; max-height: 400px; overflow-y: auto; }
        .review-item { margin-bottom: 20px; padding: 12px; border-radius: 8px; border: 1px solid #f1f1f1; background: #fff; }
        .wrong-tag { color: var(--error); font-weight: bold; font-size: 12px; }
        .right-tag { color: var(--success); font-weight: bold; font-size: 12px; }
        .wrong-text { color: var(--error); text-decoration: line-through; margin-bottom: 8px; font-size: 16px; }
        .right-text { color: var(--success); font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="title">å››å¹´çº§è¯­æ–‡è¯è¯­é—¯å…³</h1>
    <div id="loading" style="text-align:center; padding:50px;">æ­£åœ¨ä»äº‘ç«¯åŠ è½½è¯åº“...</div>

    <div id="main-menu" class="hidden">
        <p style="text-align:center; color:#7f8c8d; margin-bottom:20px;">è¯·é€‰æ‹©æŒ‘æˆ˜æ¨¡å¼</p>
        <button class="btn btn-main" onclick="start(1)">1. æ ‡æ³¨æ‹¼éŸ³ç»ƒä¹ </button>
        <button class="btn btn-main" onclick="start(2)">2. æ˜“é”™è¯»éŸ³è¾¨æ (æ‰¾å…¨å¯¹ç»„)</button>
        <button class="btn btn-main" onclick="start(3)">3. æ˜“é”™å­—å½¢è¾¨æ (æ‰¾å…¨å¯¹ç»„)</button>
    </div>

    <div id="quiz-page" class="hidden">
        <div class="progress-bar" id="prog-txt"></div>
        <div id="quiz-content"></div>
    </div>

    <div id="result-page" class="hidden">
        <h2 style="text-align:center; color:var(--success)">æŒ‘æˆ˜ç»“æŸï¼</h2>
        <div id="score-box" style="text-align:center; font-size:24px; font-weight:bold; margin:20px 0;"></div>
        <div id="result-detail" class="result-card"></div>
        <button class="btn btn-main" style="margin-top:25px; background:#2ecc71" onclick="location.reload()">å›åˆ°ä¸»èœå•</button>
    </div>
</div>

<script>
const PROJECT_ID = "wqvegiyfqpbqgzpmrrds";
const ANON_KEY = "sb_publishable_iLS1hJ8VgcxVFraIxtFPTA_71Ssmn3m";
const API_URL = `https://${PROJECT_ID}.supabase.co/rest/v1/words_library?select=w,p,trap_w,trap_p`;

let fullData = [], list = [], mode = 0, idx = 0, score = 0, history = [];

async function init() {
    try {
        const response = await fetch(API_URL, { 
            headers: { 'apikey': ANON_KEY, 'Authorization': `Bearer ${ANON_KEY}` } 
        });
        fullData = await response.json();
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('main-menu').classList.remove('hidden');
    } catch (err) {
        document.getElementById('loading').innerHTML = `âŒ è¿æ¥å¤±è´¥`;
    }
}

function start(m) {
    mode = m; idx = 0; score = 0; history = [];
    list = [...fullData].sort(() => Math.random() - 0.5);
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('quiz-page').classList.remove('hidden');
    render();
}

function render() {
    const content = document.getElementById('quiz-content');
    const prog = document.getElementById('prog-txt');
    if (idx >= list.length) { showFinal(); return; }

    if (mode === 1) {
        prog.innerText = `è¿›åº¦ï¼š${idx + 1} / ${list.length}`;
        content.innerHTML = `<div class="pinyin-box">${list[idx].p}</div><button class="btn btn-main" onclick="idx++; render();">ä¸‹ä¸€é¢˜</button>`;
    } else {
        prog.innerText = `é¢˜ç›®ï¼š${Math.floor(idx/3) + 1} / ${Math.ceil(list.length/3)}`;
        generateChallenge();
    }
}

function generateChallenge() {
    const content = document.getElementById('quiz-content');
    
    // 1. Correct Group (3 unique words from list)
    let correctGroup = list.slice(idx, idx + 3);
    while(correctGroup.length < 3) correctGroup.push(fullData[Math.floor(Math.random()*fullData.length)]);
    
    // Create a Set of words currently in the question to prevent duplicates
    let usedWords = new Set(correctGroup.map(item => item.w));

    // 2. Filter Pool for Traps (Exclude words already in correctGroup)
    let trapPool = fullData.filter(item => {
        const hasTrap = mode === 2 ? (item.trap_p && item.trap_p.trim() !== "") : (item.trap_w && item.trap_w.trim() !== "");
        return hasTrap && !usedWords.has(item.w);
    });

    // 3. Filter Pool for Fillers (Exclude words already in usedWords)
    let fillerPool = fullData.filter(item => !usedWords.has(item.w));

    let options = [];
    
    for (let i = 0; i < 3; i++) {
        let isCorrect = (i === 0); 
        let rowItems = [];
        let trapPos = -1;

        if (isCorrect) {
            rowItems = [...correctGroup];
        } else {
            // Pick 1 Trap word from trapPool
            let trapIdx = Math.floor(Math.random() * trapPool.length);
            let trapItem = trapPool.splice(trapIdx, 1)[0] || fullData[0];
            usedWords.add(trapItem.w);

            // Pick 2 Fillers from fillerPool
            let fillers = [];
            for(let j=0; j<2; j++) {
                let fIdx = Math.floor(Math.random() * fillerPool.length);
                let fItem = fillerPool.splice(fIdx, 1)[0] || fullData[1];
                fillers.push(fItem);
                usedWords.add(fItem.w);
            }
            
            rowItems = [trapItem, ...fillers];
            trapPos = 0; 

            // Shuffle these 3 words internally
            for (let j = 2; j > 0; j--) {
                const k = Math.floor(Math.random() * (j + 1));
                [rowItems[j], rowItems[k]] = [rowItems[k], rowItems[j]];
                if (j === trapPos) trapPos = k; else if (k === trapPos) trapPos = j;
            }
        }

        let displayArr = rowItems.map((item, pos) => {
            if (!isCorrect && pos === trapPos) {
                return mode === 2 ? `${item.w}(${item.trap_p})` : item.trap_w;
            }
            return mode === 2 ? `${item.w}(${item.p})` : item.w;
        });

        options.push({
            text: displayArr.join("ã€"),
            isCorrect: isCorrect,
            correctAnswer: rowItems.map(item => mode === 2 ? `${item.w}(${item.p})` : item.w).join("ã€")
        });
    }

    options.sort(() => Math.random() - 0.5);
    const actualCorrectText = options.find(o => o.isCorrect).correctAnswer;

    content.innerHTML = `<h3 style="font-size:18px; margin-bottom:20px;">æ‰¾å‡ºä¸€ç»„ <span style="color:var(--accent)">å®Œå…¨æ­£ç¡®</span> çš„è¯è¯­ï¼š</h3>` +
        options.map(o => `<button class="btn opt-btn" onclick="handleSelect(${o.isCorrect}, '${o.text}', '${actualCorrectText}')">${o.text}</button>`).join('');
}

function handleSelect(isCorrect, selected, correct) {
    if (isCorrect) score++;
    else history.push({ selected, correct });
    idx += 3; 
    render();
}

function showFinal() {
    document.getElementById('quiz-page').classList.add('hidden');
    const resPage = document.getElementById('result-page');
    resPage.classList.remove('hidden');
    const total = mode === 1 ? list.length : Math.ceil(list.length/3);
    const rate = Math.round((score / total) * 100);
    document.getElementById('score-box').innerText = mode === 1 ? "å®Œæˆç»ƒä¹ " : `å¾—åˆ†ï¼š${rate}%`;
    const detail = document.getElementById('result-detail');
    if (mode === 1) {
        detail.innerHTML = list.map(i => `<div style="padding:10px; border-bottom:1px solid #eee;">${i.p} â†’ <b>${i.w}</b></div>`).join('');
    } else {
        detail.innerHTML = history.length > 0 ? `<p style="font-weight:bold; color:var(--error);">é”™é¢˜å›é¡¾ï¼š</p>` + history.map(h => `<div class="review-item"><div class="wrong-tag">ä½ çš„é€‰æ‹©ï¼š</div><div class="wrong-text">${h.selected}</div><div class="right-tag">æ­£ç¡®ç­”æ¡ˆï¼š</div><div class="right-text">${h.correct}</div></div>`).join('') : `<p style="text-align:center; padding:30px; color:var(--success);">ğŸŒŸ å®Œç¾é€šå…³ï¼</p>`;
    }
}
init();
</script>
</body>
</html>
